services:
  mysql:
    image: mysql:8.0
    container_name: gt_mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: globetrotter
      MYSQL_USER: gt_user
      MYSQL_PASSWORD: gt_pass
    ports:
      - "3307:3306"
    command: ["mysqld", "--default-authentication-plugin=mysql_native_password"]
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d

  postgres:
    image: postgres:16
    container_name: gt_postgres
    environment:
      POSTGRES_USER: gt_user
      POSTGRES_PASSWORD: gt_pass
      POSTGRES_DB: globetrotter
    ports:
      - "5433:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data

  flyway:
    image: flyway/flyway:10
    container_name: gt_flyway
    depends_on:
      - postgres
    environment:
      FLYWAY_URL: jdbc:postgresql://gt_postgres:5432/globetrotter
      FLYWAY_USER: gt_user
      FLYWAY_PASSWORD: gt_pass
      FLYWAY_LOCATIONS: filesystem:/flyway/sql
    volumes:
      - ./flyway/sql:/flyway/sql
    command: migrate

  app_faker:
    image: python:3.12-slim
    container_name: gt_app_faker
    depends_on:
      - mysql
    volumes:
      - ./app_faker:/app
    working_dir: /app
    command: sh -c "pip install -r requirements.txt && python faker_traffic.py"

  app_cdc:
    image: python:3.12-slim
    container_name: gt_app_cdc
    depends_on:
      - mysql
      - postgres
    volumes:
      - ./app_cdc:/app
    working_dir: /app
    command: sh -c "pip install -r requirements.txt && python cdc_replication.py"

volumes:
  mysql_data:
  pg_data:
